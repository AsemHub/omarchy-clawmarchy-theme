---
phase: 01-hyprland-foundation-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [hyprland.conf]
autonomous: true
requirements: [FNDTN-01, FNDTN-02]

must_haves:
  truths:
    - "All windows display at full opacity (1.0) via the override keyword, preventing gray wash from Omarchy's default 0.97/0.9 multiplier"
    - "Layer surfaces (Waybar, Mako, SwayOSD, Walker) have blur disabled via dedicated layerrule directives, not windowrule"
    - "Config includes commented transparency exception examples showing users how to carve out apps that functionally need transparency"
    - "The old catch-all rule (opacity 1.0 1.0 without override) is replaced, not duplicated"
  artifacts:
    - path: "hyprland.conf"
      provides: "Targeted window opacity rules and layer surface rules"
      contains: "opacity 1.0 override 1.0 override"
  key_links:
    - from: "hyprland.conf"
      to: "Omarchy default windows.conf"
      via: "override keyword superseding the default 0.97/0.9 opacity catch-all"
      pattern: "opacity 1\\.0 override 1\\.0 override.*match:class \\.\\*"
    - from: "hyprland.conf"
      to: "Waybar, Mako, SwayOSD, Walker layer surfaces"
      via: "layerrule directives targeting each by namespace"
      pattern: "layerrule = blur off, match:namespace"
---

<objective>
Replace the global opacity catch-all in hyprland.conf with targeted window rules using the `override` keyword and add dedicated `layerrule` directives for all layer surfaces. This fixes the foundation so that (a) all windows get true AMOLED black without gray wash, (b) layer surfaces are controlled independently from windows, and (c) Phase 2+ can theme Waybar/Mako/SwayOSD/Walker without interference from window opacity rules.

Purpose: Unblock all subsequent desktop component theming by separating window opacity control from layer surface control at the compositor level.
Output: Updated hyprland.conf with targeted window opacity rules (FNDTN-01) and layer surface rules (FNDTN-02).
</objective>

<execution_context>
@/home/asem/.claude/get-shit-done/workflows/execute-plan.md
@/home/asem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-hyprland-foundation-fix/01-RESEARCH.md
@.planning/phases/01-hyprland-foundation-fix/01-CONTEXT.md
@hyprland.conf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace global opacity catch-all with override-based targeted rule and transparency exceptions</name>
  <files>hyprland.conf</files>
  <action>
In hyprland.conf, replace the existing "AMOLED Opacity Fix" section (lines 18-25) with a new "Window Opacity Rules" section that:

1. **Replace the catch-all rule.** Change:
   ```
   windowrule = opacity 1.0 1.0, match:class .*
   ```
   To:
   ```
   windowrule = opacity 1.0 override 1.0 override, match:class .*
   ```
   The `override` keyword after each value sets ABSOLUTE opacity instead of multiplying with Omarchy's default 0.97/0.9 rule from `windows.conf`. Without `override`, Hyprland multiplies all matching rules: 1.0 * 0.97 = 0.97, causing gray wash on AMOLED black.

2. **Add commented transparency exception examples.** Below the catch-all, add a "Transparency Exceptions" subsection with:
   - A comment block explaining the exception mechanism: these are for apps that FUNCTIONALLY require transparency (not aesthetic preference)
   - Instructions showing how to find app class names: `hyprctl clients | grep class`
   - Commented-out example exceptions for `hyprpicker` (color picker) and `slurp` (screen region selector) using `opacity unset` syntax
   - A note that users can add their own exceptions by copying the pattern

3. **Update the section header comment.** Change the section identifier from `FX-01` to `FNDTN-01` and update the description to reference the `override` keyword and its purpose.

Keep the section in the same position (after Border Colors, before Visual Effects). Do NOT move or modify the Border Colors section or the Visual Effects section.
  </action>
  <verify>
Verify the updated hyprland.conf:
- Contains exactly one `windowrule = opacity` line with `override` keyword: `windowrule = opacity 1.0 override 1.0 override, match:class .*`
- Does NOT contain the old rule `windowrule = opacity 1.0 1.0, match:class .*` (without override)
- Contains commented exception examples with `hyprpicker` and `slurp`
- Contains user-facing instructions for finding app class names
- Border Colors section (top) and Visual Effects section (bottom) are unchanged
  </verify>
  <done>The global opacity catch-all uses the `override` keyword to set absolute 1.0 opacity on all windows, preventing multiplicative stacking with Omarchy's default 0.97/0.9 rule. Commented transparency exception examples are present for user customization.</done>
</task>

<task type="auto">
  <name>Task 2: Add layerrule directives for all layer surfaces</name>
  <files>hyprland.conf</files>
  <action>
In hyprland.conf, add a new "Layer Surface Rules" section between the Window Opacity Rules section (Task 1) and the Visual Effects section. This section implements FNDTN-02.

1. **Add section header comment** in the existing config comment style:
   ```
   # ----------------------------------------------------------
   # Layer Surface Rules (FNDTN-02)
   # Layer surfaces (status bar, notifications, popups, launcher)
   # use layerrule, not windowrule. Hyprland does NOT support
   # setting opacity via layerrule -- layer surface backgrounds
   # are controlled by each app's own config (Phase 2).
   # These rules disable compositor effects (blur) to prevent
   # background bleed-through on AMOLED black surfaces.
   # Verify namespaces with: hyprctl layers
   # ----------------------------------------------------------
   ```

2. **Add layerrule for each known layer surface**, disabling blur:
   ```
   layerrule = blur off, match:namespace waybar
   layerrule = blur off, match:namespace mako
   layerrule = blur off, match:namespace swayosd
   layerrule = blur off, match:namespace walker
   ```
   Each rule gets an inline comment identifying the surface:
   - `waybar` -- status bar
   - `mako` -- notification daemon
   - `swayosd` -- volume/brightness OSD popups (namespace may vary; note to verify with `hyprctl layers`)
   - `walker` -- app launcher (namespace may vary; note to verify with `hyprctl layers`)

3. **Important implementation notes:**
   - Do NOT add `opacity` to any layerrule -- it is not a valid layerrule action (Hyprland issue #4267)
   - Do NOT add `no_anim` or other effects at this point -- blur off is the only compositor-level change needed for Phase 1 (animations are orthogonal to the opacity/transparency concern)
   - Use one-line anonymous rules (not block syntax) for simplicity
   - The SwayOSD and Walker namespaces are best-guess from documentation; include a comment noting they should be verified with `hyprctl layers` on a running system
  </action>
  <verify>
Verify the updated hyprland.conf:
- Contains a "Layer Surface Rules (FNDTN-02)" section header
- Contains exactly 4 `layerrule = blur off` lines targeting: waybar, mako, swayosd, walker
- Does NOT contain any `layerrule = opacity` lines (invalid action)
- Layer rules section appears AFTER the Window Opacity Rules section and BEFORE the Visual Effects section
- The section header includes the `hyprctl layers` verification command
  </verify>
  <done>Four layer surfaces (Waybar, Mako, SwayOSD, Walker) have dedicated layerrule directives disabling blur to prevent background bleed-through. Layer surfaces are controlled independently from windows, unblocking Phase 2 component theming.</done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full hyprland.conf structure:

1. **Section order:** Border Colors -> Window Opacity Rules -> Layer Surface Rules -> Visual Effects
2. **No old rules:** The file does NOT contain `windowrule = opacity 1.0 1.0, match:class .*` (without override)
3. **Override present:** The file contains `windowrule = opacity 1.0 override 1.0 override, match:class .*`
4. **Layer rules present:** The file contains 4 `layerrule = blur off` lines
5. **No invalid actions:** No `layerrule = opacity` lines exist
6. **Existing sections preserved:** Border Colors (general + group blocks) and Visual Effects (decoration + animations blocks) are unchanged
7. **Self-documenting:** Config includes comments explaining the override keyword, transparency exception pattern, layer namespace verification command, and why layerrule cannot control opacity
</verification>

<success_criteria>
- hyprland.conf uses `override` keyword in the opacity catch-all rule, preventing gray wash from multiplicative stacking with Omarchy defaults
- Layer surfaces have dedicated `layerrule` directives separate from window rules
- Config is self-documenting with commented examples for user customization
- All existing config sections (Border Colors, Visual Effects) are preserved unchanged
- Phase 2+ can theme Waybar/Mako/SwayOSD/Walker without interference from window opacity rules
</success_criteria>

<output>
After completion, create `.planning/phases/01-hyprland-foundation-fix/01-01-SUMMARY.md`
</output>
